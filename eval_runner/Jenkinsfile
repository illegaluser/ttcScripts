pipeline {
    agent any

    parameters {
        string(name: 'TARGET_URL', defaultValue: '', description: '평가할 외부 API 주소')
        string(name: 'TARGET_TYPE', defaultValue: 'http', description: '어댑터 타입(http/dify/...)')
        string(name: 'HOST_KNOWLEDGE_PATH', defaultValue: '/Users/luuuuunatic/Developer/dscore-ttc/data/knowledges', description: '호스트 지식 데이터 경로')
        string(name: 'HOST_SCRIPTS_PATH', defaultValue: '/Users/luuuuunatic/Developer/dscore-ttc/data/jenkins/scripts', description: '호스트 스크립트 경로')
    }

    environment {
        // Docker Desktop 호스트 접근 주소
        OLLAMA_HOST = "http://host.docker.internal:11434"
    }

    stages {
        stage('Validation') {
            steps {
                script {
                    if (params.TARGET_URL == '') error "TARGET_URL required."
                }
            }
        }

        stage('Run Evaluation') {
            steps {
                // API Key 등 민감 정보 주입 (Jenkins Credentials 필요)
                withCredentials([string(credentialsId: 'external-ai-api-key', variable: 'SAFE_API_KEY')]) {
                    script {
                        sh """
                        set +x
                        docker run --rm \
                            --network devops-net \
                            -v ${params.HOST_KNOWLEDGE_PATH}/eval/data:/app/data \
                            -v ${params.HOST_KNOWLEDGE_PATH}/eval/reports:/app/reports \
                            -v ${params.HOST_SCRIPTS_PATH}/eval_runner/adapters:/app/adapters \
                            -v ${params.HOST_SCRIPTS_PATH}/eval_runner/tests:/app/tests \
                            -v ${params.HOST_SCRIPTS_PATH}/eval_runner/configs:/app/configs \
                            -e OLLAMA_BASE_URL=${OLLAMA_HOST} \
                            -e TARGET_URL='${params.TARGET_URL}' \
                            -e TARGET_TYPE='${params.TARGET_TYPE}' \
                            -e API_KEY='${SAFE_API_KEY}' \
                            dscore-eval-runner:v1-fat \
                            pytest /app/tests/test_runner.py -n 1 --junitxml=/app/reports/results.xml
                        set -x
                        """
                    }
                }
            }
        }

        stage('Publish Report') {
            steps {
                // JUnit 리포트 발행 (Jenkins 플러그인 필요)
                junit 'reports/results.xml'
            }
        }
    }
}